# =============================================================================
# weAlist Project - Base Docker Compose Configuration
# =============================================================================
# 이 파일은 모든 환경(dev, prod)에서 공통으로 사용되는 기본 서비스 정의입니다.
# 환경별 차이는 docker-compose.{env}.yml 파일에서 오버라이드합니다.
#
# 사용법:
#   개발: docker compose -f docker/compose/docker-compose.yml -f docker/compose/docker-compose.dev.yml up
#   운영: docker compose -f docker/compose/docker-compose.yml -f docker/compose/docker-compose.prod.yml up
# =============================================================================

services:
  # ===========================================================================
  # Backend Services
  # ===========================================================================

  # User Service (Spring Boot)
  user-service:
    build:
      context: ../../user-service
      dockerfile: Dockerfile
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: wealist/user-service:${VERSION:-latest}
    container_name: wealist-user-service
    hostname: user-service

    environment:
      # Server Configuration
      - SERVER_PORT=8080
      - USER_SERVICE_PORT=8080
      - APP_NAME=${APP_NAME}

      # Database Configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${USER_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${USER_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${USER_DB_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver

      # JPA/Hibernate Configuration
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${JPA_DDL_AUTO}
      - SPRING_JPA_SHOW_SQL=${JPA_SHOW_SQL}
      - SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=${JPA_FORMAT_SQL}
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_REDIS_DATABASE=0

      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=${JWT_ACCESS_TOKEN_EXPIRATION_MS}
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=${JWT_REFRESH_TOKEN_EXPIRATION_MS}

      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # Service URLs
      - BOARD_SERVICE_URL=http://board-service:8000

      # Sample Data Configuration
      - SAMPLE_DATA_ENABLED=${SAMPLE_DATA_ENABLED:-false}

      # Java Options
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0

    networks:
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      # liveness probe 사용: DB 연결과 무관하게 서비스 자체 상태만 체크
      # EKS에서 DB 장애 시에도 pod가 재시작되지 않도록 함
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8080/actuator/health/liveness",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Auth Service (Spring Boot) - 토큰 관리 전용
  auth-service:
    build:
      context: ../../auth-service
      dockerfile: Dockerfile
      args:
        CACHEBUST: ${CACHEBUST:-1}
    image: wealist/auth-service:${VERSION:-latest}
    container_name: wealist-auth-service
    hostname: auth-service

    environment:
      # Server Configuration
      - SERVER_PORT=8090
      - AUTH_SERVICE_PORT=8090
      - APP_NAME=${APP_NAME:-wealist-auth}

      # Redis Configuration
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION_MS=${JWT_ACCESS_TOKEN_EXPIRATION_MS}
      - JWT_REFRESH_TOKEN_EXPIRATION_MS=${JWT_REFRESH_TOKEN_EXPIRATION_MS}

      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - OAUTH2_CLIENT_REDIRECT_URI=${OAUTH2_CLIENT_REDIRECT_URI:-http://localhost:8080/login/oauth2/code/google}
      - OAUTH2_REDIRECT_URL_ENV=${OAUTH2_REDIRECT_URL:-http://localhost:3000/oauth/callback}

      # User Service URL (OAuth 로그인 시 유저 조회/생성용)
      - USER_SERVICE_URL=http://user-service:8080

      # Java Options
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0

    networks:
      - backend-net
      - database-net

    depends_on:
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy

    healthcheck:
      # liveness probe 사용: Redis 연결과 무관하게 서비스 자체 상태만 체크
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8090/actuator/health/liveness",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Board Service (Go)
  board-service:
    build:
      context: ../../board-service
      dockerfile: docker/Dockerfile
    image: wealist/board-service:${VERSION:-latest}
    container_name: wealist-board-service
    hostname: board-service

    environment:
      # Server Configuration
      - ENV=${ENVIRONMENT}
      - BOARD_SERVER_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL}

      # Database Configuration
      - DATABASE_URL=postgresql://${BOARD_DB_USER}:${BOARD_DB_PASSWORD}@postgres:5432/${BOARD_DB_NAME}?sslmode=disable

      # Redis Configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1

      # JWT Configuration (로컬 검증용 - fallback)
      - SECRET_KEY=${JWT_SECRET}

      # Service URLs
      - USER_SERVICE_URL=http://user-service:8080
      - AUTH_SERVICE_URL=http://auth-service:8090

      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS}

    networks:
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy

    healthcheck:
      # liveness probe 사용: /health는 DB 연결과 무관하게 서비스 상태만 체크
      # readiness는 /ready 엔드포인트로 별도 확인 가능
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend Service
  frontend-service:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
    image: wealist/frontend:${VERSION:-latest}
    container_name: wealist-frontend
    hostname: frontend

    networks:
      - frontend-net

    depends_on:
      - user-service
      - auth-service
      - board-service

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Infrastructure Services
  # ===========================================================================

  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: wealist-postgres
    hostname: postgres

    environment:
      - POSTGRES_USER=${POSTGRES_SUPERUSER}
      - POSTGRES_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}
      - POSTGRES_INITDB_ARGS=--locale-provider=icu --icu-locale=en-US
      - USER_DB_NAME=${USER_DB_NAME}
      - USER_DB_USER=${USER_DB_USER}
      - USER_DB_PASSWORD=${USER_DB_PASSWORD}
      - BOARD_DB_NAME=${BOARD_DB_NAME}
      - BOARD_DB_USER=${BOARD_DB_USER}
      - BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../../docker/init/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro

    networks:
      - database-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Security: Run as non-root user
    user: postgres

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: wealist-redis
    hostname: redis

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --databases 16
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec

    volumes:
      - redis-data:/data

    networks:
      - database-net

    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "--no-auth-warning",
          "-a",
          "${REDIS_PASSWORD}",
          "ping",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Networks
# =============================================================================
networks:
  # Frontend network: NGINX ↔ Frontend
  frontend-net:
    driver: bridge
    name: wealist-frontend-net

  # Backend network: Frontend/NGINX ↔ Backend Services
  backend-net:
    driver: bridge
    name: wealist-backend-net

  # Database network: Backend Services ↔ Database/Redis
  database-net:
    driver: bridge
    name: wealist-database-net
    internal: true # 외부 접근 차단

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
    name: wealist-postgres-data
    driver: local

  redis-data:
    name: wealist-redis-data
    driver: local
