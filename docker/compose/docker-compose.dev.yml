# =============================================================================
# weAlist Project - Development Environment Override
# =============================================================================
# ê°œë°œ í™˜ê²½ì— íŠ¹í™”ëœ ì„¤ì •ì„ ì˜¤ë²„ë¼ì´ë“œí•©ë‹ˆë‹¤.
#
# íŠ¹ì§•:
# - ëª¨ë“  í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ì— ë…¸ì¶œ (ë””ë²„ê¹… ìš©ì´)
# - í”„ë¡ íŠ¸ì—”ë“œ Hot Module Reload (HMR) ì§€ì›
# - ë°ì´í„°ë² ì´ìŠ¤ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥
# - ìƒì„¸í•œ ë¡œê¹…
# - ë¦¬ì†ŒìŠ¤ ì œí•œ ì—†ìŒ
#
# ì‚¬ìš©ë²•:
#   docker compose -f docker/compose/docker-compose.yml -f docker/compose/docker-compose.dev.yml up
# =============================================================================

services:
  # ===========================================================================
  # Backend Services - Development Overrides
  # ===========================================================================

  user-service:
    env_file:
      - ../env/.env.dev
    ports:
      - "${USER_HOST_PORT:-8090}:8080"

    environment:
      # ê°œë°œ í™˜ê²½ ì „ìš© ì„¤ì •
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_JPA_SHOW_SQL=true
      - SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=true
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK=DEBUG
      - LOGGING_LEVEL_ORG_HIBERNATE=DEBUG
      # S3 Configuration
      - AWS_S3_BUCKET=${S3_BUCKET}
      - AWS_S3_REGION=${S3_REGION}
      - AWS_S3_ENDPOINT=${S3_ENDPOINT}
      - AWS_S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - AWS_S3_SECRET_KEY=${S3_SECRET_KEY}

    # ê°œë°œ ì¤‘ ì½”ë“œ ë³€ê²½ ê°ì§€ (ì„ íƒì‚¬í•­)
    # volumes:
    #   - ../../user-service/build/libs:/app/libs:ro

    depends_on:
      minio:
        condition: service_healthy

    networks:
      - frontend-net
      - backend-net
      - database-net

  # Auth Service - Development Overrides
  auth-service:
    env_file:
      - ../env/.env.dev
    ports:
      - "${AUTH_HOST_PORT:-8080}:8090"

    environment:
      # ê°œë°œ í™˜ê²½ ì „ìš© ì„¤ì •
      - SPRING_PROFILES_ACTIVE=dev
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY=DEBUG
      - LOGGING_LEVEL_ORANGECLOUD=DEBUG

    networks:
      - frontend-net
      - backend-net
      - database-net

  board-service:
    healthcheck:
      # liveness probe: /healthëŠ” DB ì—°ê²°ê³¼ ë¬´ê´€í•˜ê²Œ ì„œë¹„ìŠ¤ ìƒíƒœë§Œ ì²´í¬
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8000/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    build:
      context: ../../board-service
      dockerfile: docker/Dockerfile
    env_file:
      - ../env/.env.dev
    ports:
      - "${BOARD_HOST_PORT:-8000}:8000"

    environment:
      - ENV=dev
      - LOG_LEVEL=debug
      - BOARD_USE_AUTO_MIGRATE=true
      # S3 Configuration
      - S3_BUCKET=${S3_BUCKET}
      - S3_REGION=${S3_REGION}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}

    depends_on:
      minio:
        condition: service_healthy

    networks:
      - frontend-net
      - backend-net
      - database-net

  chat-service:
    build:
      context: ../../chat-service
      dockerfile: docker/Dockerfile
    container_name: wealist-chat-service
    hostname: chat-service

    environment:
      - ENV=dev
      - SERVER_PORT=8001
      - SERVER_BASE_PATH=/api/chats
      - LOG_LEVEL=debug
      - DATABASE_URL=postgresql://${CHAT_DB_USER}:${CHAT_DB_PASSWORD}@postgres:5432/${CHAT_DB_NAME}?sslmode=disable
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
      - SECRET_KEY=${JWT_SECRET}
      - USER_SERVICE_URL=http://user-service:8080/api/users
      - AUTH_SERVICE_URL=http://auth-service:8090
      - CORS_ORIGINS=${CORS_ORIGINS}

    ports:
      - "${CHAT_HOST_PORT:-8001}:8001"

    networks:
      - frontend-net
      - backend-net
      - database-net

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy

    healthcheck:
      # liveness probe: /api/chats/healthëŠ” DB ì—°ê²°ê³¼ ë¬´ê´€í•˜ê²Œ ì„œë¹„ìŠ¤ ìƒíƒœë§Œ ì²´í¬
      # readinessëŠ” /api/chats/ready ë˜ëŠ” /ready ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³„ë„ í™•ì¸ ê°€ëŠ¥
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:8001/api/chats/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  # NGINX - API Gateway for Local Development
  nginx:
    image: nginx:alpine
    container_name: wealist-nginx-dev
    hostname: nginx

    ports:
      - "80:80"

    volumes:
      - ../nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro

    networks:
      - frontend-net
      - backend-net

    depends_on:
      - user-service
      - auth-service
      - board-service
      - chat-service

    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend - Development with HMR
  frontend-service:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.local

    env_file:
      - ../env/.env.dev

    ports:
      - "${FRONTEND_HOST_PORT:-3000}:5173"

    volumes:
      # ì†ŒìŠ¤ì½”ë“œ Hot Reload
      - ../../frontend:/app
      - /app/node_modules # node_modulesëŠ” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²ƒ ì‚¬ìš©

    command: pnpm dev --host 0.0.0.0 --port 5173 --strictPort

    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost
      - LOG_LEVEL=debug # ğŸ”¥ ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

    networks:
      - frontend-net
      - backend-net # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì§ì ‘ API í˜¸ì¶œ ê°€ëŠ¥

    depends_on:
      - nginx

  # ===========================================================================
  # Infrastructure Services - Development Overrides
  # ===========================================================================

  postgres:
    env_file:
      - ../env/.env.dev

    ports:
      # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥ (DB í´ë¼ì´ì–¸íŠ¸ íˆ´ ì‚¬ìš©)
      - "${POSTGRES_HOST_PORT:-5432}:5432"

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../../docker/init/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
      # ê°œë°œìš© SQL ìŠ¤í¬ë¦½íŠ¸ (ì„ íƒì‚¬í•­)
      # - ../../docker/init/postgres/seed-dev.sql:/docker-entrypoint-initdb.d/seed-dev.sql:ro

    environment:
      # ê°œë°œ í™˜ê²½ ì „ìš©
      - POSTGRES_HOST_AUTH_METHOD=trust # ë¡œì»¬ ê°œë°œ í¸ì˜ì„± (í”„ë¡œë•ì…˜ X)

    networks:
      - database-net
      # ê°œë°œ í™˜ê²½ì—ì„œëŠ” internal ì œí•œ í•´ì œ

  redis:
    env_file:
      - ../env/.env.dev

    ports:
      # Redis CLI ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥
      - "${REDIS_HOST_PORT:-6379}:6379"

    # ê°œë°œ í™˜ê²½ì—ì„œëŠ” persistence ì¤„ì„
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --databases 16
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no

    networks:
      - database-net

  # MinIO - S3 Compatible Object Storage (Local Development Only)
  minio:
    image: minio/minio:latest
    container_name: wealist-minio-dev
    hostname: minio

    ports:
      - "${MINIO_PORT:-9000}:9000"      # API Port
      - "${MINIO_CONSOLE_PORT:-9001}:9001"  # Console Port

    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_DOMAIN=minio
      - MINIO_REGION_NAME=${AWS_REGION:-ap-northeast-2}

    volumes:
      - minio-data:/data

    command: server /data --console-address ":9001"

    networks:
      - backend-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MinIO Client - Create bucket on startup
  minio-init:
    image: minio/mc:latest
    container_name: wealist-minio-init
    depends_on:
      minio:
        condition: service_healthy

    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-wealist-dev-files}

    entrypoint: >
      /bin/sh -c "
      mc alias set minio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb minio/$${S3_BUCKET} --ignore-existing;
      mc anonymous set download minio/$${S3_BUCKET};
      echo 'MinIO bucket $${S3_BUCKET} created successfully';
      exit 0;
      "

    networks:
      - backend-net

# =============================================================================
# Development Networks Override
# =============================================================================
networks:
  database-net:
    internal: false # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©

# =============================================================================
# Development Volumes
# =============================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
